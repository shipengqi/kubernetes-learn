<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    <title>Kubernetes learning | 认证 </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/kubernetes-learn/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/kubernetes-learn/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"认证","path":"auth/authentication.html"},"data":{"navigation":{"logo":{"text":"Kubernetes Learn","type":"link","path":"index.html"},"main":[{"text":"核心组件","type":"label"},{"text":"Kubernetes 核心组件","type":"link","path":"components/README.html"},{"text":"ETCD","type":"link","path":"components/etcd.html"},{"text":"kube-apiserver","type":"link","path":"components/apiserver.html"},{"text":"kube-scheduler","type":"link","path":"components/scheduler.html"},{"text":"kube-controller-manager","type":"link","path":"components/controller-manager.html"},{"text":"kubelet","type":"link","path":"components/kubelet.html"},{"text":"kube-proxy","type":"link","path":"components/proxy.html"},{"text":"kube-dns","type":"link","path":"components/dns.html"},{"text":"kubectl","type":"link","path":"components/kubectl.html"},{"text":"Federation","type":"link","path":"components/federation.html"},{"text":"Pod","type":"label"},{"text":"Pod 简介","type":"link","path":"pod/README.html"},{"text":"Pod 生命周期","type":"link","path":"pod/lifecycle.html"},{"text":"Init 容器","type":"link","path":"pod/init.html"},{"text":"Pod 安全策略","type":"link","path":"pod/pod-security-policy.html"},{"text":"Pod Preset","type":"link","path":"pod/pod-preset.html"},{"text":"Pod 中断与 PDB","type":"link","path":"pod/pdb.html"},{"text":"集群资源管理","type":"label"},{"text":"Node","type":"link","path":"cluster/node.html"},{"text":"Namespace","type":"link","path":"cluster/namespace.html"},{"text":"Label","type":"link","path":"cluster/label.html"},{"text":"Annotation","type":"link","path":"cluster/annotation.html"},{"text":"Taints 和 tolerations","type":"link","path":"cluster/taint.html"},{"text":"垃圾收集","type":"link","path":"cluster/garbage-collection.html"},{"text":"控制器","type":"label"},{"text":"Deployment","type":"link","path":"controller/deployment.html"},{"text":"StatefulSet","type":"link","path":"controller/stateful-set.html"},{"text":"DaemonSet","type":"link","path":"controller/daemon-set.html"},{"text":"ReplicaSet","type":"link","path":"controller/rc-rs.html"},{"text":"Job","type":"link","path":"controller/job.html"},{"text":"CronJob","type":"link","path":"controller/cron-job.html"},{"text":"Horizontal Pod Autoscaling","type":"link","path":"controller/hpa.html"},{"text":"准入控制","type":"link","path":"controller/admission.html"},{"text":"服务发现","type":"label"},{"text":"Service","type":"link","path":"service-discovery/service.html"},{"text":"Ingress","type":"link","path":"service-discovery/ingress.html"},{"text":"身份与权限","type":"label"},{"text":"身份与权限控制","type":"link","path":"auth/README.html"},{"text":"认证","type":"link","path":"auth/authentication.html"},{"text":"授权","type":"link","path":"auth/authorization.html"},{"text":"Service Account","type":"link","path":"auth/service-account.html"},{"text":"RBAC","type":"link","path":"auth/rbac.html"},{"text":"STORAGE","type":"label"},{"text":"Secret","type":"link","path":"storage/secret.html"},{"text":"ConfigMap","type":"link","path":"storage/configmap.html"},{"text":"Volume","type":"link","path":"storage/volume.html"},{"text":"Persistent Volume","type":"link","path":"storage/pv.html"},{"text":"StorageClass","type":"link","path":"storage/storageclass.html"},{"text":"THEME","type":"label"},{"text":"使用文档主题","type":"link","path":"theme/theme-usage.html"},{"text":"SUPPORT AND FEEDBACK","type":"label"},{"text":"Raise an Issue on Github","type":"link","path":"https://github.com/shipengqi/kubernetes-learn/issues/new"}]}},"config":{"timezone":"UTC","root":"/kubernetes-learn/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/kubernetes-learn/index.html" class="doc-navbar__logo"><img src="/kubernetes-learn/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">Kubernetes Learn</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><p>Kubernetes 支持多种认证机制，并支持同时开启多个认证插件。<strong>开启 TLS 时，所有的请求都需要首先认证</strong>。</p>
<h2 id="X509-证书"><a href="#X509-证书" class="headerlink" title="X509 证书"></a>X509 证书</h2><p>使用 X509 客户端证书只需要 API Server 启动时配置 <code>--client-ca-file=SOMEFILE</code>。在证书<strong>认证时，其 Common Name（CN）域用作用户名，而 Organization（O）域则用作 group 名</strong>。</p>
<p>创建一个客户端证书：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create private key</span></span><br><span class="line">openssl genrsa -out username.key 2048</span><br><span class="line"><span class="comment"># Create CSR (certificate signing request)</span></span><br><span class="line">openssl req -new -key username.key -out username.csr -subj <span class="string">"/CN=username/O=group"</span></span><br><span class="line"><span class="comment"># Create certificate from CSR using the cluster authority</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> username.csr -CA <span class="variable">$CA_LOCATION</span>/ca.crt -CAkey <span class="variable">$CA_LOCATION</span>/ca.key -CAcreateserial -out username.crt -days 365</span><br></pre></td></tr></table></figure></p>
<p>例如，目前我们的 kubernetes 集群就是 X509 证书认证并结合 RBAC。<br>集群中 dashboard 组件访问 API server 就是使用的证书认证，证书的 CN 是 <code>k8s-dashboard-svc.core</code>，dashboard 的 pod 需要 <code>cluster-admin</code> 权限，所以<br>我们又为 dashboard 了 <code>ClusterRoleBinding</code>：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">cdf:dashboard:cluster-admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-dashboard-svc.core</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure></p>
<p>下面是 dashboard <code>--kubeconfig=&lt;kubeconfig&gt;</code> 的具体配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">  - cluster:</span></span><br><span class="line"><span class="attr">      certificate-authority:</span> <span class="string">&#123;HOME_DIR&#125;/ssl/ca.crt</span></span><br><span class="line"><span class="attr">      server:</span> <span class="attr">https://&#123;K8S_APISERVER_IP&#125;:&#123;MASTER_API_SSL_PORT&#125;</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="attr">  - context:</span></span><br><span class="line"><span class="attr">      cluster:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">kubelet</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">kubelet-to-kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubelet-to-kubernetes</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kubelet</span></span><br><span class="line"><span class="attr">    user:</span></span><br><span class="line"><span class="attr">      client-certificate:</span> <span class="string">&#123;HOME_DIR&#125;/ssl/&#123;PREFIX&#125;.crt</span></span><br><span class="line"><span class="attr">      client-key:</span> <span class="string">&#123;HOME_DIR&#125;/ssl/&#123;PREFIX&#125;.key</span></span><br></pre></td></tr></table></figure></p>
<h2 id="静态-Token-文件"><a href="#静态-Token-文件" class="headerlink" title="静态 Token 文件"></a>静态 Token 文件</h2><p>使用静态 Token 文件认证只需要 API Server 启动时配置 <code>--token-auth-file=SOMEFILE</code>。该文件为 csv 格式，每行至少包括三列 token,user,uid，后面是可选的 group 名，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token,user,uid,&quot;group1,group2,group3&quot;</span><br></pre></td></tr></table></figure></p>
<p>客户端在使用 token 认证时，需要在请求头中加入 <code>Bearer Authorization</code> 头，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer 31ada4fd-adec-460c-809a-9e56ceb75269</span><br></pre></td></tr></table></figure></p>
<h2 id="静态密码文件"><a href="#静态密码文件" class="headerlink" title="静态密码文件"></a>静态密码文件</h2><p>只需要 API Server 启动时配置 <code>--basic-auth-file=SOMEFILE</code>。该文件为 csv 格式，每行至少包括三列 password,user,uid，后面是可选的 group 名，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password,user,uid,&quot;group1,group2,group3&quot;</span><br></pre></td></tr></table></figure></p>
<p>客户端在使用 token 认证时，需要在请求头中加入 <code>Basic Authorization</code> 头，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Basic BASE64ENCODED(USER:PASSWORD)</span><br></pre></td></tr></table></figure></p>
<h2 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h2><p>参考<a href="./service-account.html">这里</a></p>
<h2 id="OpenID"><a href="#OpenID" class="headerlink" title="OpenID"></a>OpenID</h2><p>OpenID 提供了 OAuth2 的认证机制，是很多云服务商（如 GCE、Azure 等）的首选认证方法。</p>
<p>使用 OpenID 认证，API Server 需要配置<br><code>--oidc-issuer-url</code>，如 <code>https://accounts.google.com</code><br><code>--oidc-client-id</code>，如 kubernetes<br><code>--oidc-username-claim</code>，如 sub<br><code>--oidc-groups-claim</code>，如 groups<br><code>--oidc-ca-file</code>，如 <code>/etc/kubernetes/ssl/kc-ca.pem</code></p>
<p><img src="../imgs/oidc.png" alt></p>
<p>参考<a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-lo-openid-connect-kubernetes-authentication/index.html" target="_blank" rel="noopener">这里</a><br>和<a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-lo-openid-connect-kubernetes-authentication2/index.html" target="_blank" rel="noopener">这里</a></p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/kubernetes-learn/script/doc.js"></script>

    

  </body>
</html>
