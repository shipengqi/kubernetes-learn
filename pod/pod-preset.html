<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    <title>Kubernetes learning | PodPreset </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/kubernetes-learn/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/kubernetes-learn/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"PodPreset","path":"pod/pod-preset.html"},"data":{"navigation":{"logo":{"text":"Kubernetes Learn","type":"link","path":"index.html"},"main":[{"text":"核心组件","type":"label"},{"text":"Kubernetes 核心组件","type":"link","path":"components/README.html"},{"text":"ETCD","type":"link","path":"components/etcd.html"},{"text":"kube-apiserver","type":"link","path":"components/apiserver.html"},{"text":"kube-scheduler","type":"link","path":"components/scheduler.html"},{"text":"kube-controller-manager","type":"link","path":"components/controller-manager.html"},{"text":"kubelet","type":"link","path":"components/kubelet.html"},{"text":"kube-proxy","type":"link","path":"components/proxy.html"},{"text":"kube-dns","type":"link","path":"components/dns.html"},{"text":"kubectl","type":"link","path":"components/kubectl.html"},{"text":"Federation","type":"link","path":"components/federation.html"},{"text":"Pod","type":"label"},{"text":"Pod 简介","type":"link","path":"pod/README.html"},{"text":"Pod 生命周期","type":"link","path":"pod/lifecycle.html"},{"text":"Init 容器","type":"link","path":"pod/init.html"},{"text":"Pod 安全策略","type":"link","path":"pod/pod-security-policy.html"},{"text":"Pod Preset","type":"link","path":"pod/pod-preset.html"},{"text":"Pod 中断与 PDB","type":"link","path":"pod/pdb.html"},{"text":"集群资源管理","type":"label"},{"text":"Node","type":"link","path":"cluster/node.html"},{"text":"Namespace","type":"link","path":"cluster/namespace.html"},{"text":"Label","type":"link","path":"cluster/label.html"},{"text":"Annotation","type":"link","path":"cluster/annotation.html"},{"text":"Taints 和 tolerations","type":"link","path":"cluster/taint.html"},{"text":"垃圾收集","type":"link","path":"cluster/garbage-collection.html"},{"text":"控制器","type":"label"},{"text":"Deployment","type":"link","path":"controller/deployment.html"},{"text":"StatefulSet","type":"link","path":"controller/stateful-set.html"},{"text":"DaemonSet","type":"link","path":"controller/daemon-set.html"},{"text":"ReplicaSet","type":"link","path":"controller/rc-rs.html"},{"text":"Job","type":"link","path":"controller/job.html"},{"text":"CronJob","type":"link","path":"controller/cron-job.html"},{"text":"Horizontal Pod Autoscaling","type":"link","path":"controller/hpa.html"},{"text":"准入控制","type":"link","path":"controller/admission.html"},{"text":"服务发现","type":"label"},{"text":"Service","type":"link","path":"service-discovery/service.html"},{"text":"Ingress","type":"link","path":"service-discovery/ingress.html"},{"text":"身份与权限","type":"label"},{"text":"身份与权限控制","type":"link","path":"auth/README.html"},{"text":"认证","type":"link","path":"auth/authentication.html"},{"text":"授权","type":"link","path":"auth/authorization.html"},{"text":"Service Account","type":"link","path":"auth/service-account.html"},{"text":"RBAC","type":"link","path":"auth/rbac.html"},{"text":"STORAGE","type":"label"},{"text":"Secret","type":"link","path":"storage/secret.html"},{"text":"ConfigMap","type":"link","path":"storage/configmap.html"},{"text":"Volume","type":"link","path":"storage/volume.html"},{"text":"Persistent Volume","type":"link","path":"storage/pv.html"},{"text":"StorageClass","type":"link","path":"storage/storageclass.html"},{"text":"THEME","type":"label"},{"text":"使用文档主题","type":"link","path":"theme/theme-usage.html"},{"text":"SUPPORT AND FEEDBACK","type":"label"},{"text":"Raise an Issue on Github","type":"link","path":"https://github.com/shipengqi/kubernetes-learn/issues/new"}]}},"config":{"timezone":"UTC","root":"/kubernetes-learn/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/kubernetes-learn/index.html" class="doc-navbar__logo"><img src="/kubernetes-learn/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">Kubernetes Learn</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="PodPreset"><a href="#PodPreset" class="headerlink" title="PodPreset"></a>PodPreset</h1><p><code>PodPreset</code> 用来给指定 <a href="../cluster/label.html">Label</a> 的 Pod 注入额外的信息，比如有时候想要让一批容器在启动的时候就注入一些信息，如环境变量、存储卷等。<br>这样，Pod 模板就不需要为每个 Pod 都显式设置重复的信息。</p>
<h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><p>在启用了准入控制器（<code>PodPreset</code>）时，Pod Preset 会将应用创建请求传入到该控制器上。当有 Pod 创建请求发生时，系统将执行以下操作：</p>
<ol>
<li>检索所有可用的 <code>PodPresets</code>。</li>
<li>检查 <code>PodPreset</code> 标签选择器上的标签，看看其是否能够匹配正在创建的 Pod 上的标签。</li>
<li>尝试将由 <code>PodPreset</code> 定义的各种资源合并到正在创建的 Pod 中。</li>
<li>出现错误时，在该 Pod 上引发记录合并错误的事件，<code>PodPreset</code> 不会注入任何资源到创建的 Pod 中。</li>
<li>注释刚生成的修改过的 Pod spec，以表明它已被 <code>PodPreset</code> 修改过。注释的格式为<br><code>podpreset.admission.kubernetes.io/podpreset-&lt;pod-preset name&gt;&quot;: &quot;&lt;resource version&gt;&quot;</code>。</li>
</ol>
<p>每个 Pod 可以匹配零个或多个 Pod Prestet；并且每个 <code>PodPreset</code> 可以应用于零个或多个 Pod。</p>
<h2 id="开启-Pod-Preset"><a href="#开启-Pod-Preset" class="headerlink" title="开启 Pod Preset"></a>开启 Pod Preset</h2><ul>
<li>开启 API <code>settings.k8s.io/v1alpha1/podpreset</code>，通过 API server <code>--runtime-config</code> 包含 <code>settings.k8s.io/v1alpha1=true</code>，<br>如 <code>--runtime-config=autoscaling/v2beta1=true,settings.k8s.io/v1alpha1=true</code>。</li>
<li>开启准入控制 <code>PodPreset</code>，对于 1.10 及更高版本 API server <code>--enable-admission-plugins</code> 包含 <code>PodPreset</code> 选项。在以前的版本<br>是 <code>--admission-control</code>  包含 <code>PodPreset</code> 选项。</li>
</ul>
<blockquote>
<p><code>--admission-control</code> （顺序有关） 在 1.10 中已弃用并替换为 <code>--enable-admission-plugins</code> （顺序无关紧要）。</p>
</blockquote>
<h2 id="禁用特定-Pod-的-Pod-Preset"><a href="#禁用特定-Pod-的-Pod-Preset" class="headerlink" title="禁用特定 Pod 的 Pod Preset"></a>禁用特定 Pod 的 Pod Preset</h2><p>在某些情况下，可能不希望 Pod 被任何 Pod Preset 所改变。在这些情况下，您可以在 Pod 的 Pod Spec 中添加注释：<code>podpreset.admission.kubernetes.io/exclude：&quot;true&quot;</code>。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p><code>preset.yaml</code>：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">settings.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodPreset</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">allow-database</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      role:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">DB_PORT</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">"6379"</span></span><br><span class="line"><span class="attr">  volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/cache</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>上面的例子，新的 <code>PodPreset</code> 会匹配任何具有 label <code>role: frontend</code> 的 pod，并注入预设的配置。</p>
<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://k8s.io/examples/podpreset/preset.yaml</span><br></pre></td></tr></table></figure>
<h3 id="Pod-Preset-使用-ConfigMap"><a href="#Pod-Preset-使用-ConfigMap" class="headerlink" title="Pod Preset 使用 ConfigMap"></a>Pod Preset 使用 ConfigMap</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-env-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  number_of_members:</span> <span class="string">"1"</span></span><br><span class="line"><span class="attr">  initial_cluster_state:</span> <span class="string">new</span></span><br><span class="line"><span class="attr">  initial_cluster_token:</span> <span class="string">DUMMY_ETCD_INITIAL_CLUSTER_TOKEN</span></span><br><span class="line"><span class="attr">  discovery_token:</span> <span class="string">DUMMY_ETCD_DISCOVERY_TOKEN</span></span><br><span class="line"><span class="attr">  discovery_url:</span> <span class="attr">http://etcd_discovery:2379</span></span><br><span class="line"><span class="attr">  etcdctl_peers:</span> <span class="attr">http://etcd:2379</span></span><br><span class="line"><span class="attr">  duplicate_key:</span> <span class="string">FROM_CONFIG_MAP</span></span><br><span class="line"><span class="attr">  REPLACE_ME:</span> <span class="string">"a value"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># PodPreset</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">settings.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodPreset</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">allow-database</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      role:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">DB_PORT</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">"6379"</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">duplicate_key</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">FROM_ENV</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">expansion</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">$(REPLACE_ME)</span></span><br><span class="line"><span class="attr">  envFrom:</span></span><br><span class="line"><span class="attr">    - configMapRef:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">etcd-env-config</span></span><br><span class="line"><span class="attr">  volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/cache</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/app/config.json</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">secret-volume</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">secret-volume</span></span><br><span class="line"><span class="attr">      secret:</span></span><br><span class="line"><span class="attr">        secretName:</span> <span class="string">config-details</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 用户提交的 Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">ecorp/website</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 经过准入控制 PodPreset 后，Pod 会自动增加 ConfigMap 环境变量</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">podpreset.admission.kubernetes.io/allow-database:</span> <span class="string">"resource version"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">website</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">ecorp/website</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/cache</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/app/config.json</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">secret-volume</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"6379"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">duplicate_key</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">FROM_ENV</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">expansion</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">$(REPLACE_ME)</span></span><br><span class="line"><span class="attr">      envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">etcd-env-config</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">secret-volume</span></span><br><span class="line"><span class="attr">      secretName:</span> <span class="string">config-details</span></span><br></pre></td></tr></table></figure>
<p>更多 <a href="https://kubernetes.io/docs/tasks/inject-data-application/podpreset/" target="_blank" rel="noopener">使用 PodPreset 的例子</a></p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/kubernetes-learn/script/doc.js"></script>

    

  </body>
</html>
