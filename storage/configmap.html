<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    <title>Kubernetes learning | ConfigMap </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/kubernetes-learn/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/kubernetes-learn/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"ConfigMap","path":"storage/configmap.html"},"data":{"navigation":{"logo":{"text":"Kubernetes Learn","type":"link","path":"index.html"},"main":[{"text":"核心组件","type":"label"},{"text":"Kubernetes 核心组件","type":"link","path":"components/README.html"},{"text":"ETCD","type":"link","path":"components/etcd.html"},{"text":"kube-apiserver","type":"link","path":"components/apiserver.html"},{"text":"kube-scheduler","type":"link","path":"components/scheduler.html"},{"text":"kube-controller-manager","type":"link","path":"components/controller-manager.html"},{"text":"kubelet","type":"link","path":"components/kubelet.html"},{"text":"kube-proxy","type":"link","path":"components/proxy.html"},{"text":"kube-dns","type":"link","path":"components/dns.html"},{"text":"kubectl","type":"link","path":"components/kubectl.html"},{"text":"Federation","type":"link","path":"components/federation.html"},{"text":"Pod","type":"label"},{"text":"Pod 简介","type":"link","path":"pod/README.html"},{"text":"Pod 生命周期","type":"link","path":"pod/lifecycle.html"},{"text":"Init 容器","type":"link","path":"pod/init.html"},{"text":"Pod 安全策略","type":"link","path":"pod/pod-security-policy.html"},{"text":"Pod Preset","type":"link","path":"pod/pod-preset.html"},{"text":"Pod 中断与 PDB","type":"link","path":"pod/pdb.html"},{"text":"集群资源管理","type":"label"},{"text":"Node","type":"link","path":"cluster/node.html"},{"text":"Namespace","type":"link","path":"cluster/namespace.html"},{"text":"Label","type":"link","path":"cluster/label.html"},{"text":"Annotation","type":"link","path":"cluster/annotation.html"},{"text":"Taints 和 tolerations","type":"link","path":"cluster/taint.html"},{"text":"垃圾收集","type":"link","path":"cluster/garbage-collection.html"},{"text":"控制器","type":"label"},{"text":"Deployment","type":"link","path":"controller/deployment.html"},{"text":"StatefulSet","type":"link","path":"controller/stateful-set.html"},{"text":"DaemonSet","type":"link","path":"controller/daemon-set.html"},{"text":"ReplicaSet","type":"link","path":"controller/rc-rs.html"},{"text":"Job","type":"link","path":"controller/job.html"},{"text":"CronJob","type":"link","path":"controller/cron-job.html"},{"text":"Horizontal Pod Autoscaling","type":"link","path":"controller/hpa.html"},{"text":"准入控制","type":"link","path":"controller/admission.html"},{"text":"服务发现","type":"label"},{"text":"Service","type":"link","path":"service-discovery/service.html"},{"text":"Ingress","type":"link","path":"service-discovery/ingress.html"},{"text":"身份与权限","type":"label"},{"text":"身份与权限控制","type":"link","path":"auth/README.html"},{"text":"认证","type":"link","path":"auth/authentication.html"},{"text":"授权","type":"link","path":"auth/authorization.html"},{"text":"Service Account","type":"link","path":"auth/service-account.html"},{"text":"RBAC","type":"link","path":"auth/rbac.html"},{"text":"STORAGE","type":"label"},{"text":"Secret","type":"link","path":"storage/secret.html"},{"text":"ConfigMap","type":"link","path":"storage/configmap.html"},{"text":"Volume","type":"link","path":"storage/volume.html"},{"text":"Persistent Volume","type":"link","path":"storage/pv.html"},{"text":"StorageClass","type":"link","path":"storage/storageclass.html"},{"text":"THEME","type":"label"},{"text":"使用文档主题","type":"link","path":"theme/theme-usage.html"},{"text":"SUPPORT AND FEEDBACK","type":"label"},{"text":"Raise an Issue on Github","type":"link","path":"https://github.com/shipengqi/kubernetes-learn/issues/new"}]}},"config":{"timezone":"UTC","root":"/kubernetes-learn/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/kubernetes-learn/index.html" class="doc-navbar__logo"><img src="/kubernetes-learn/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">Kubernetes Learn</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h1><p><code>ConfigMap</code> 是 <code>Kubernetes</code> 中的一种用来<strong>存储配置</strong>的资源对象。</p>
<a id="more"></a>
<p><code>ConfigMap</code> 可以<strong>将配置信息与 <code>image</code> 解耦合，当配置改变时，我们只需要修改 <code>ConfigMap</code> 保存的数据，而不需要重新 <code>build</code> 新的 <code>image</code></strong>。<br><code>ConfigMap</code> 可以用来存储配置文件，也可以存储 <code>JSON</code> 对象。如果有敏感信息要存储，使用 <a href="./secret.html">Secret</a>。</p>
<h2 id="创建-ConfigMap"><a href="#创建-ConfigMap" class="headerlink" title="创建 ConfigMap"></a>创建 ConfigMap</h2><h3 id="使用-yaml-创建"><a href="#使用-yaml-创建" class="headerlink" title="使用 yaml 创建"></a>使用 yaml 创建</h3><p><code>example.yml</code> 文件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">example.how:</span> <span class="string">hello</span></span><br><span class="line">  <span class="string">example.type:</span> <span class="string">kube</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f example.yaml</span><br></pre></td></tr></table></figure>
<h3 id="使用-create-configmap-命令创建"><a href="#使用-create-configmap-命令创建" class="headerlink" title="使用 create configmap 命令创建"></a>使用 <code>create configmap</code> 命令创建</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap NAME [--from-literal=key1=value1] [--from-env-file=<span class="built_in">source</span>] [--from-file=[key=]<span class="built_in">source</span>] [--dry-run]</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li><code>--from-literal</code>，配置信息，该参数可以使用多次。</li>
<li><code>--from-env-file</code>，</li>
<li><code>--from-file</code>，指定的目录下的所有文件都会被用在 <code>ConfigMap</code> 里面创建一个 <code>key/value</code> 键值对，<code>key</code> 的名字就是文件名，<code>value</code> 就是文件的内容，参数可以使用多次。<ul>
<li><code>key</code>，当 <code>--from-file</code> 指定的是一个文件目录时，可以为每个文件设置 <code>key</code>，而不使用文件名来作为 <code>key</code>， 如 <code>--from-file=config1=example/a</code>。</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 key/value 字符串创建</span></span><br><span class="line">kubectl create configmap example-config --from-literal=example.how=hello</span><br><span class="line">configmap <span class="string">"example-config"</span> created</span><br><span class="line">kubectl get configmap example-config -o go-template=<span class="string">'&#123;&#123;.data&#125;&#125;'</span></span><br><span class="line">map[example.how:hello]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 env 文件创建</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"a=b\nc=d"</span> | tee example.env</span><br><span class="line">a=b</span><br><span class="line">c=d</span><br><span class="line"></span><br><span class="line">kubectl create configmap example-config --from-env-file=example.env</span><br><span class="line">configmap <span class="string">"example-config"</span> created</span><br><span class="line"></span><br><span class="line">kubectl get configmap example-config -o go-template=<span class="string">'&#123;&#123;.data&#125;&#125;'</span></span><br><span class="line">map[a:b c:d]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用目录创建</span></span><br><span class="line">mkdir example</span><br><span class="line"><span class="built_in">echo</span> avalue &gt; example/a</span><br><span class="line"><span class="built_in">echo</span> bvalue &gt; example/b</span><br><span class="line"><span class="comment"># --from-file=example/ 这里的 example/ 也可以不带 /</span></span><br><span class="line">kubectl create configmap example-config --from-file=example/</span><br><span class="line">configmap <span class="string">"example-config"</span> created</span><br><span class="line">kubectl get configmap example-config -o go-template=<span class="string">'&#123;&#123;.data&#125;&#125;'</span></span><br><span class="line">map[a:avalue</span><br><span class="line"> b:bvalue</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 key</span></span><br><span class="line">kubectl create configmap my-config --from-file=config1=example/a --from-file=config2=example/b</span><br><span class="line"></span><br><span class="line">kubectl get configmap example-config -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config1: |</span><br><span class="line">    a</span><br><span class="line">  config2: |</span><br><span class="line">    b</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-08-13T06:01:59Z</span><br><span class="line">  name: my-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"5318721"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/my-config</span><br><span class="line">  uid: 6425e0ce-9ebe-11e8-93fa-005056b02a1c</span><br></pre></td></tr></table></figure>
<h2 id="ConfigMap-使用"><a href="#ConfigMap-使用" class="headerlink" title="ConfigMap 使用"></a>ConfigMap 使用</h2><p><code>Pod</code> 中使用 <code>ConfigMap</code> 的方式有三种：</p>
<ul>
<li>设置环境变量</li>
<li>设置容器命令行参数</li>
<li>在 Volume 中挂载</li>
</ul>
<p>使用 <code>ConfigMap</code> 要注意下面几点：</p>
<ul>
<li><code>ConfigMap</code> 必须在 <code>Pod</code> 使用它之前创建</li>
<li>使用 <code>envFrom</code>，会自动忽略无效的键</li>
<li><code>Pod</code> 只能使用和它在同一个命名空间内的 <code>ConfigMap</code></li>
</ul>
<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><p>创建两个 <code>ConfigMap</code>：<br><code>example-config.yml</code>：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">example.how:</span> <span class="string">hello</span></span><br><span class="line">  <span class="string">example.type:</span> <span class="string">kube</span></span><br></pre></td></tr></table></figure></p>
<p><code>env-config.yml</code>：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">env-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  log_level:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure></p>
<p>使用 <code>example-pod.yml</code>：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">example-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">gcr.io/google_containers/busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SPECIAL_LEVEL_KEY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">example.how</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">example.type</span></span><br><span class="line"><span class="attr">      envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">env-config</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure></p>
<p>Pod 结束后会输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SPECIAL_LEVEL_KEY=hello</span><br><span class="line">SPECIAL_TYPE_KEY=kube</span><br><span class="line">log_level=INFO</span><br></pre></td></tr></table></figure></p>
<h3 id="设置容器命令行参数"><a href="#设置容器命令行参数" class="headerlink" title="设置容器命令行参数"></a>设置容器命令行参数</h3><p>修改 <code>example-pod.yml</code>，先把 <code>ConfigMap</code> 的数据保存到环境变量中，然后通过 <code>$(VAR_NAME)</code> 的方式引用环境变量：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">gcr.io/google_containers/busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SPECIAL_LEVEL_KEY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">example.how</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SPECIAL_TYPE_KEY</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">example.type</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure></p>
<p>运行 <code>Pod</code> 后会输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello kube</span><br></pre></td></tr></table></figure></p>
<h3 id="在-Volume-中挂载"><a href="#在-Volume-中挂载" class="headerlink" title="在 Volume 中挂载"></a>在 Volume 中挂载</h3><p>修改 <code>example-pod.yml</code>，将 <code>ConfigMap</code> 挂载到 <code>Pod</code> 的 <code>/etc/config</code> 目录下，其中每一个 <code>key/value</code> 键值对都会生成一个文件，<code>key</code> 为文件名，<code>value</code> 为内容：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vol-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">gcr.io/google_containers/busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"cat /etc/config/example.how"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">        mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">      configMap:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure></p>
<p>运行 <code>Pod</code> 后会输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br></pre></td></tr></table></figure></p>
<h4 id="挂载指定-key-到指定路径"><a href="#挂载指定-key-到指定路径" class="headerlink" title="挂载指定 key 到指定路径"></a>挂载指定 <code>key</code> 到指定路径</h4><p>将 <code>ConfigMap</code> 中的 key <code>example.how</code> 挂载到了 <code>/etc/config</code> 目录下的一个相对路径 <code>keys/example.level</code>，如果存在同名文件，直接覆盖。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">gcr.io/google_containers/busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh","-c","cat</span> <span class="string">/etc/config/keys/example.level"]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">        mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">      configMap:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">example-config</span></span><br><span class="line"><span class="attr">        items:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">example.how</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">keys/example.level</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure></p>
<p>运行 <code>Pod</code> 后会输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br></pre></td></tr></table></figure></p>
<h4 id="挂载多个-key-和多个目录"><a href="#挂载多个-key-和多个目录" class="headerlink" title="挂载多个 key 和多个目录"></a>挂载多个 key 和多个目录</h4><p>将 <code>ConfigMap</code> 中的 key  <code>example.how</code> 和 <code>example.type</code> 挂载到了 <code>/etc/config</code> 目录下，<code>example.how</code> 挂载到了 <code>/etc/config2</code> 目录。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">gcr.io/google_containers/busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh","-c","sleep</span> <span class="number">36000</span><span class="string">"]</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">      - name: config-volume</span></span><br><span class="line"><span class="string">        mountPath: /etc/config</span></span><br><span class="line"><span class="string">      - name: config-volume2</span></span><br><span class="line"><span class="string">        mountPath: /etc/config2</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: config-volume</span></span><br><span class="line"><span class="string">      configMap:</span></span><br><span class="line"><span class="string">        name: example-config</span></span><br><span class="line"><span class="string">        items:</span></span><br><span class="line"><span class="string">        - key: example.how</span></span><br><span class="line"><span class="string">          path: keys/example.level</span></span><br><span class="line"><span class="string">        - key: special.type</span></span><br><span class="line"><span class="string">          path: keys/example.type</span></span><br><span class="line"><span class="string">    - name: config-volume2</span></span><br><span class="line"><span class="string">      configMap:</span></span><br><span class="line"><span class="string">        name: example-config</span></span><br><span class="line"><span class="string">        items:</span></span><br><span class="line"><span class="string">        - key: example.how</span></span><br><span class="line"><span class="string">          path: keys/example.level</span></span><br><span class="line"><span class="string">  restartPolicy: Never</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls  /etc/config/keys/</span></span><br><span class="line">example.level  example.type</span><br><span class="line"><span class="comment"># ls  /etc/config2/keys/</span></span><br><span class="line">example.level</span><br><span class="line"><span class="comment"># cat  /etc/config/keys/example.level</span></span><br><span class="line">hello</span><br><span class="line"><span class="comment"># cat  /etc/config/keys/example.type</span></span><br><span class="line">kube</span><br></pre></td></tr></table></figure>
<h4 id="使用-subPath"><a href="#使用-subPath" class="headerlink" title="使用 subPath"></a>使用 subPath</h4><p>使用 <code>subPath</code> 可以将 <code>configmap</code> 中的每个 <code>key</code>，按照文件的方式挂载到目录下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-container</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh","-c","sleep</span> <span class="number">36000</span><span class="string">"]</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">      - name: config-volume</span></span><br><span class="line"><span class="string">        mountPath: /etc/config3/example.how</span></span><br><span class="line"><span class="string">        subPath: example.how</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: config-volume</span></span><br><span class="line"><span class="string">      configMap:</span></span><br><span class="line"><span class="string">        name: example-config</span></span><br><span class="line"><span class="string">        items:</span></span><br><span class="line"><span class="string">        - key: example.how</span></span><br><span class="line"><span class="string">          path: example.how</span></span><br><span class="line"><span class="string">  restartPolicy: Never</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ConfigMap-热更新"><a href="#ConfigMap-热更新" class="headerlink" title="ConfigMap 热更新"></a>ConfigMap 热更新</h2><p>如果 <code>ConfigMap</code> 更新了，那么：</p>
<ul>
<li><code>Pod</code> 中使用该 <code>ConfigMap</code> 配置的环境变量不会同步更新，环境变量是在容器启动的时候注入的，启动之后就不会再改变环境变量的值。</li>
<li><code>Pod</code> 中使用该 <code>ConfigMap</code> 挂载的 <code>Volume</code> 中的文件在一段时间（大概10秒）会同步更新，如果使用 ConfigMap 的 <code>subPath</code> 挂载为 Container 的 Volume，Kubernetes<br>不会做自动热更新，<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically" target="_blank" rel="noopener">known issue</a>。</li>
</ul>
<p><code>ConfigMap</code> 更新并不会触发相关 <code>Pod</code> 的滚动更新。可以通过修改 pod annotations 的方式强制触发滚动更新：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch deployment my-nginx --patch <span class="string">'&#123;"spec": &#123;"template": &#123;"metadata": &#123;"annotations": &#123;"version/config": "20180411" &#125;&#125;&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>这里我们在 <code>.spec.template.metadata.annotations</code> 中添加 <code>version/config</code>，每次通过修改 <code>version/config</code> 来触发滚动更新。</p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/kubernetes-learn/script/doc.js"></script>

    

  </body>
</html>
